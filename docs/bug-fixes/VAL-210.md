# VAL-210: Card Type Detection Fix

## Purpose of the PR

Fixes VAL-210 - Card type validation only checks basic prefixes, missing many valid cards.

## What caused the bug?

The original card type validation was too simplistic:

```typescript
const validPrefix =
  value.startsWith("4") || // Visa
  value.startsWith("5") || // Mastercard - WRONG!
  value.startsWith("34") || // Amex
  value.startsWith("37") || // Amex
  value.startsWith("6"); // Discover - WRONG!
```

**Problems:**
- **Mastercard**: Only checked `startsWith("5")` but Mastercard uses:
  - 51-55 (traditional range)
  - 2221-2720 (new BIN range added in 2017)
- **Discover**: Only checked `startsWith("6")` but Discover uses:
  - 6011 (original prefix)
  - 622126-622925 (China UnionPay co-branded)
  - 644-649 (additional range)
  - 65 (additional prefix)

This caused valid cards to be rejected with "Invalid card type" error.

## How did you fix it?

Created comprehensive card type detection based on ISO/IEC 7812 and card network specifications:

```typescript
function detectCardType(cardNumber: string): CardType {
  const digits = cardNumber.replace(/[\s-]/g, "");

  // Visa: Starts with 4
  if (digits.startsWith("4")) return "visa";

  // American Express: Starts with 34 or 37
  if (digits.startsWith("34") || digits.startsWith("37")) return "amex";

  // Mastercard: 51-55 or 2221-2720
  const first2 = parseInt(digits.substring(0, 2), 10);
  const first4 = parseInt(digits.substring(0, 4), 10);
  if ((first2 >= 51 && first2 <= 55) || (first4 >= 2221 && first4 <= 2720)) {
    return "mastercard";
  }

  // Discover: 6011, 622126-622925, 644-649, 65
  if (digits.startsWith("6011") || digits.startsWith("65")) return "discover";
  const first6 = parseInt(digits.substring(0, 6), 10);
  if (first6 >= 622126 && first6 <= 622925) return "discover";
  const first3 = parseInt(digits.substring(0, 3), 10);
  if (first3 >= 644 && first3 <= 649) return "discover";

  return "unknown";
}
```

## What preventive measures can avoid similar issues?

1. **Research card network specifications** before implementing validation
2. **Use range-based validation** instead of simple prefix checks
3. **Keep validation updated** as card networks add new BIN ranges
4. **Test with real-world card number patterns** (test card numbers from each network)
5. **Consider using a library** like `card-validator` for production systems

## How to test it?

### Run unit tests
```bash
npm test -- --no-coverage
```

### Manual testing

Test these card number patterns (use Luhn-valid test numbers):

| Card Type | Valid Prefixes | Example Test Number |
|-----------|----------------|---------------------|
| Visa | 4xxx | 4111111111111111 |
| Mastercard (old) | 51-55 | 5500000000000004 |
| Mastercard (new) | 2221-2720 | 2223000048400011 |
| Amex | 34, 37 | 378282246310005 |
| Discover | 6011 | 6011111111111117 |
| Discover | 65 | 6500000000000002 |
| Discover | 644-649 | 6440000000000000 |

**Steps:**
1. Go to Dashboard â†’ Fund Account
2. Select "Credit/Debit Card"
3. Enter each test card number
4. Verify it's accepted (passes card type check)
5. Try an invalid prefix like "9999..." â†’ should show "Unsupported card type"

